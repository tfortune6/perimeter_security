# 智能周界安全平台 - 前后端接口文档（通俗版）

> 面向后端同学：这份文档根据前端当前实现（`security-system-frontend/src/api/*` + `src/mocks/handlers.js`）整理，目的是让你**快速对齐前端需要什么接口、怎么传参、期望返回什么数据**。
>
> **Base URL**：前端所有请求都以 `/api` 为前缀。
>
> **鉴权**：除登录外，所有接口都要求请求头：
>
> `Authorization: Bearer <token>`
>
> 前端 token 存在 `localStorage.token`，并由 `src/api/http.js` 自动注入。

---

## 0. 通用返回结构（非常重要）

前端 axios 拦截器（`src/api/http.js`）约定：

- 只要返回对象包含 `code` 字段，就会按以下规则处理：
  - `code === 0`：认为成功，前端直接拿 `data` 字段作为结果
  - `code !== 0`：前端会抛出 Error，错误信息取 `message`

### 成功示例

```json
{
  "code": 0,
  "message": "ok",
  "data": {}
}
```

### 失败示例

```json
{
  "code": 1001,
  "message": "用户名或密码错误",
  "data": null
}
```

---

## 1. 鉴权接口（Authentication）

### 1.1 登录

- **用途**：登录换取 token
- **方法**：`POST`
- **路径**：`/api/login`
- **Body**：`application/json`

```json
{
  "username": "admin",
  "password": "admin"
}
```

- **成功返回**：

```json
{
  "code": 0,
  "message": "ok",
  "data": { "token": "demo-token" }
}
```

- **失败返回**：

```json
{
  "code": 1001,
  "message": "用户名或密码错误",
  "data": null
}
```

### 1.2 获取当前用户信息

- **用途**：获取登录用户信息（头像/姓名/角色）
- **方法**：`GET`
- **路径**：`/api/me`
- **鉴权**：需要
- **成功返回**：

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "id": "u_admin",
    "name": "Admin User",
    "role": "系统管理员",
    "avatarUrl": "https://..."
  }
}
```

---

## 2. 系统状态（System）

### 2.1 获取系统状态

- **用途**：仪表盘初始化当前选择的视频源（`currentSourceId`）
- **方法**：`GET`
- **路径**：`/api/system/status`
- **鉴权**：需要
- **成功返回**：

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "online": true,
    "version": "v2.4.1 (Stable)",
    "fps": 24,
    "currentSourceId": "vid-01"
  }
}
```

### 2.2 更新系统状态

- **用途**：仪表盘切换视频源时，写入当前 sourceId
- **方法**：`PUT`
- **路径**：`/api/system/status`
- **鉴权**：需要
- **Body**：`application/json`

```json
{
  "currentSourceId": "vid-02"
}
```

- **成功返回**：同 2.1 的 data（更新后的状态对象）

---

## 3. 视频源与视频管理（Videos & Sources）

> 说明：当前前端把“视频源(source)”与“上传视频(video)”统一成同一套 ID（`vid-xx`）。
> 
> - **视频列表**用于“视频源管理”页面（文件名/大小/时长等）
> - **sources 列表**用于仪表盘/配置中心右上角/左侧的视频源选择
>

### 3.1 获取视频源列表（供下拉选择）

- **用途**：仪表盘/配置中心视频源下拉
- **方法**：`GET`
- **路径**：`/api/sources`
- **鉴权**：需要
- **成功返回**：

```json
{
  "code": 0,
  "message": "ok",
  "data": [
    { "id": "vid-01", "name": "main_gate_entrance_24.mkv" },
    { "id": "vid-02", "name": "dock_area_21.mp4" }
  ]
}
```

### 3.2 获取已上传视频列表

- **用途**：视频源管理页面列表展示
- **方法**：`GET`
- **路径**：`/api/videos`
- **鉴权**：需要
- **Query 参数**：
  - `keyword`：可选，按文件名搜索

- **成功返回**（视频对象数组）：

```json
{
  "code": 0,
  "message": "ok",
  "data": [
    {
      "id": "vid-01",
      "name": "main_gate_entrance_24.mkv",
      "ext": "MKV",
      "quality": "1080p",
      "size": "492 MB",
      "duration": "00:08:20",
      "uploadAt": "2026-01-16 14:22",
      "isDemo": true,
      "previewUrl": "https://..."
    }
  ]
}
```

### 3.3 上传视频

- **用途**：视频源管理页面上传新视频
- **方法**：`POST`
- **路径**：`/api/videos/upload`
- **鉴权**：需要
- **Body**：`multipart/form-data`

字段：
- `file`：视频文件（必填）
- `name`：文件名（建议与 file.name 一致）
- `ext`：扩展名（MP4/MKV/WEBM...）
- `sizeBytes`：文件大小（字节）
- `durationSec`：时长（秒）
- `uploadAt`：上传时间（`YYYY-MM-DD HH:mm`）
- `size`：格式化大小（如 `492 MB`）
- `duration`：格式化时长（如 `00:08:20`）

- **成功返回**：返回新视频对象（至少要有 `id/name/ext/size/duration/uploadAt/isDemo/previewUrl`）

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "id": "vid-ab12cd",
    "name": "upload_1768573349114.mp4",
    "ext": "MP4",
    "quality": "1080p",
    "size": "3 MB",
    "duration": "00:01:15",
    "uploadAt": "2026-01-16 22:29",
    "isDemo": false,
    "previewUrl": "https://..."
  }
}
```

> 备注：前端实际播放优先使用 IndexedDB 本地文件（只要上传成功就会写入本地库），`previewUrl` 在真实后端里通常是可直接访问的视频 URL。

### 3.4 设置演示源

- **用途**：将某个视频设为仪表盘演示源
- **方法**：`POST`
- **路径**：`/api/videos/:id/set-demo`
- **鉴权**：需要
- **成功返回**：返回被更新的视频对象

### 3.5 获取演示源

- **用途**：仪表盘播放的演示视频
- **方法**：`GET`
- **路径**：`/api/videos/demo`
- **鉴权**：需要
- **成功返回**：返回一个视频对象或 `null`

### 3.6 删除视频

- **用途**：视频源管理删除某个视频
- **方法**：`DELETE`
- **路径**：`/api/videos/:id`
- **鉴权**：需要
- **成功返回**：

```json
{ "code": 0, "message": "ok", "data": true }
```

---

## 4. 区域（Zones）

> 说明：区域与视频源绑定，关键参数是 `sourceId = vid-xx`。
> 
> 前端绘图坐标系为 SVG viewBox：`800 x 450`，点格式为 `[x, y]`。

### 4.1 获取某视频源的区域列表

- **用途**：
  - 配置中心：展示/选择/编辑区域
  - 仪表盘：叠加显示区域多边形
- **方法**：`GET`
- **路径**：`/api/zones`
- **鉴权**：需要
- **Query 参数**：
  - `sourceId`：必填，视频 ID（如 `vid-01`）

- **成功返回**：

```json
{
  "code": 0,
  "message": "ok",
  "data": [
    {
      "id": "zone-01",
      "name": "仓库入口禁区",
      "type": "core",
      "threshold": 3,
      "motion": true,
      "polygonPoints": [[200, 300], [350, 280], [500, 350]]
    }
  ]
}
```

### 4.2 创建区域

- **用途**：配置中心绘制完成后创建区域
- **方法**：`POST`
- **路径**：`/api/zones`
- **鉴权**：需要
- **Query 参数**：
  - `sourceId`：必填
- **Body**：`application/json`

```json
{
  "name": "新建区域",
  "type": "core",
  "threshold": 3,
  "motion": true,
  "polygonPoints": [[10, 20], [30, 40], [50, 60]]
}
```

- **成功返回**：返回创建后的区域对象（带 `id`）

### 4.3 更新区域

- **用途**：配置中心修改区域属性或顶点后保存
- **方法**：`PUT`
- **路径**：`/api/zones/:id`
- **鉴权**：需要
- **Body**：`application/json`（支持部分字段 patch）

```json
{
  "name": "修改后的名称",
  "type": "warning",
  "threshold": 5,
  "motion": false,
  "polygonPoints": [[...], [...], ...]
}
```

- **成功返回**：返回更新后的区域对象

### 4.4 删除区域

- **用途**：配置中心删除选中区域
- **方法**：`DELETE`
- **路径**：`/api/zones/:id`
- **鉴权**：需要
- **成功返回**：

```json
{ "code": 0, "message": "ok", "data": true }
```

### 4.5 保存配置（演示接口）

- **用途**：配置中心“保存配置”按钮（目前为演示接口）
- **方法**：`POST`
- **路径**：`/api/config/save`
- **鉴权**：需要
- **Query 参数**：
  - `sourceId`：可选（前端会传）
- **成功返回**：

```json
{
  "code": 0,
  "message": "ok",
  "data": { "sourceId": "vid-01", "savedAt": "2026-01-16T...Z" }
}
```

---

## 5. 仪表盘（Dashboard）

### 5.1 获取实时事件

- **用途**：仪表盘右侧“实时事件”列表
- **方法**：`GET`
- **路径**：`/api/dashboard/events`
- **鉴权**：需要
- **Query 参数**：
  - `limit`：可选

- **成功返回**：

```json
{
  "code": 0,
  "message": "ok",
  "data": [
    {
      "id": "evt-...",
      "type": "INTRUSION",
      "level": "danger",
      "time": "22:10:24",
      "zone": "Zone A - North Gate",
      "thumbUrl": "https://...",
      "alarmId": "ALM-2023-9001"
    }
  ]
}
```

### 5.2 获取检测框叠加（Overlays）

- **用途**：仪表盘视频上的检测框/标签
- **方法**：`GET`
- **路径**：`/api/dashboard/overlays`
- **鉴权**：需要
- **Query 参数**：
  - `sourceId`：必填

- **成功返回**：

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "boxes": [
      {
        "id": "b1",
        "x": 0.45,
        "y": 0.35,
        "w": 0.12,
        "h": 0.35,
        "label": "PERSON",
        "score": 0.98,
        "level": "danger"
      }
    ]
  }
}
```

> 坐标为 0~1 的归一化坐标，前端用百分比定位。

---

## 6. 告警历史（History / Alarms）

### 6.1 获取告警列表

- **用途**：报警记录页面表格
- **方法**：`GET`
- **路径**：`/api/alarms`
- **鉴权**：需要
- **Query 参数**：
  - `page`：默认 1
  - `pageSize`：默认 10
  - `query`：可选（ID 或备注关键字）
  - `level`：可选（`critical`/`warning`）
  - `startDate`：可选（`YYYY-MM-DD`）
  - `endDate`：可选（`YYYY-MM-DD`）

- **成功返回**：

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "list": [
      {
        "id": "#ALM-2023-9001",
        "thumb": "https://...",
        "time": "2023-10-24 08:15:00",
        "target": "行人",
        "severity": "critical",
        "status": "done"
      }
    ],
    "total": 128
  }
}
```

### 6.2 获取告警详情

- **用途**：报警记录页面弹窗详情
- **方法**：`GET`
- **路径**：`/api/alarms/:id`
- **鉴权**：需要
- **Path 参数**：
  - `id`：告警 ID（前端会去掉 `#` 再请求）

- **成功返回**：返回完整 alarm 对象（包含 `zone/remark/timeline` 等）

---

## 7. 前端调用位置（方便你排查/对齐）

- **登录**：`src/views/Login.vue` → `src/api/auth.js`（或直接调用 login 接口）
- **仪表盘**：`src/views/Dashboard.vue`
  - 事件：`src/api/dashboard.js` → `/dashboard/events`
  - overlays：`src/api/dashboard.js` → `/dashboard/overlays`
  - zones：`src/api/dashboard.js` → `/zones`
  - sources：`src/api/config.js` → `/sources`
  - system status：`src/api/system.js` → `/system/status`
  - demo video：`src/api/videos.js` → `/videos/demo`
- **配置中心**：`src/views/Config.vue` → `src/api/config.js`
  - zones CRUD：`/zones`
  - saveConfig：`/config/save`
  - videos（视频源选择）：`/videos`
- **报警记录**：`src/views/History.vue` → `src/api/history.js` → `/alarms`
- **视频源管理**：`src/views/Sources.vue` → `src/api/videos.js`

---

## 8. 对接后端时的关键建议

- **[保持返回结构一致]**：必须包含 `{code,message,data}`，否则前端 axios 拦截器可能不会按预期处理。
- **[sourceId 口径统一]**：当前前端以 `videoId(vid-xx)` 作为 `sourceId`。
- **[视频播放 URL]**：真实后端建议返回可播放的 `previewUrl`（或 HLS/DASH），前端本地 IndexedDB 仅用于演示/本地缓存。
- **[区域坐标系]**：前端按 `800x450` viewBox 存点，后端可原样存储；若要适配不同分辨率，建议后端也存归一化坐标或额外存原分辨率。
