# 前端功能文档（基于当前代码实现的系统性梳理）

> 说明：以下总结覆盖 `security-system-frontend/src` 内现有实现（Vue3 + ElementPlus + Axios + MSW Mock + IndexedDB 本地视频存储），按“项目结构 / 页面功能 / 数据与接口 / 关键机制”组织。

---

## 1. 技术栈与运行方式概览

- **[框架]** Vue 3（`<script setup>`）
- **[UI 组件库]** Element Plus
- **[HTTP]** Axios（封装在 `src/api/http.js`）
- **[路由]** Vue Router（`src/router.js`）
- **[Mock]** MSW（Mock Service Worker），在 **DEV 环境**自动启用（`src/main.js`）
- **[本地存储]** IndexedDB：用于缓存用户上传的视频文件（`src/storage/videoStore.js`）
- **[视频处理]**
  - 从本地视频文件截取帧作为配置中心背景（`src/utils/video.js`）
  - 读取视频 metadata（时长/大小格式化等）（`src/utils/videoMeta.js`）

---

## 2. 项目结构（核心目录）

- `src/main.js`
  - 创建 Vue App
  - 注册 Element Plus 与 Router
  - DEV 时启用 MSW mock worker（`./mocks/browser`）
- `src/router.js`
  - 定义页面路由
  - 全局路由守卫：非 public 路由需要 `localStorage.token`
  - 根据 `meta.title` 设置 `document.title`
- `src/components/layout/AppLayout.vue`
  - 全局布局组件（顶栏、侧边栏、页脚、退出登录）
  - 侧边栏入口：
    - `/` 仪表盘
    - `/config` 配置中心
    - `/history` 报警记录
    - `/sources` 视频源管理
- `src/api/*`
  - 统一封装的 REST API 调用（走 `/api` 前缀）
- `src/mocks/*`
  - MSW mock handlers & 数据库（模拟后端）
- `src/views/*`
  - 业务页面：Dashboard / Config / History / Sources / Login
- `src/storage/videoStore.js`
  - IndexedDB：存取上传的视频文件（供播放/截帧）

---

## 3. 基础设施与通用机制

### 3.1 鉴权与登录态

- **[token 存储]** `localStorage.token`
- **[请求头注入]** `src/api/http.js` 中 Axios request interceptor：
  - 自动添加 `Authorization: Bearer <token>`
- **[路由守卫]** `src/router.js`：
  - 访问非 public 路由时，如果无 token，重定向到 `/login?redirect=...`

### 3.2 Mock 后端（DEV 环境）

- `src/main.js` 中，`import.meta.env.DEV` 时启动 MSW worker
- `src/mocks/handlers.js` 定义全部接口行为
- `src/mocks/data/db.js` 作为“内存数据库”，支撑：
  - 视频列表
  - sources（用于仪表盘/配置中心的“视频源选择”）
  - zonesBySource（按 sourceId/videoId 维度保存区域）
  - dashboard overlays（检测框等）
  - alarms（历史告警数据）

> 这意味着：DEV 下很多“后端能力”由前端 mock 提供，生产环境需对接真实后端。

---

## 4. 页面功能清单（views）

### 4.1 登录页 `src/views/Login.vue`

- **[目标]** 获取 token，进入系统
- **[交互]**
  - 输入用户名/密码后调用 `/api/login`
  - 成功保存 token 并跳转到 redirect 或默认页

### 4.2 仪表盘 `src/views/Dashboard.vue`

#### 主要功能

- **[视频播放]**
  - 播放演示/当前视频源（优先从 IndexedDB 取本地文件，否则用 mock 提供的 `previewUrl`）
  - 视频叠加显示检测框（bbox）与区域多边形（zones）
- **[视频源选择]**
  - 右上角下拉选择 source（当前实现为“上传视频列表”映射出的 source）
  - 选择后更新系统状态 `/api/system/status` 并拉取对应 overlays/zones
- **[区域叠加]**
  - 拉取 `/api/zones?sourceId=<当前sourceId>` 并在 `<svg>` 里渲染 `<polygon>`
- **[检测框叠加]**
  - 拉取 `/api/dashboard/overlays?sourceId=<当前sourceId>` 并渲染 bbox
- **[实时事件]**
  - 拉取 `/api/dashboard/events`，右侧列表显示事件卡片（可跳转到历史页）
- **[定时刷新]**
  - 3 秒轮询刷新：events、演示源、zones
  - 同时会轮询刷新 sources（让“新上传视频”能自动出现在下拉中）
- **[全屏功能]**
  - 右下角 `Fullscreen` 按钮：对视频容器 `requestFullscreen()` / `exitFullscreen()`
  - 监听 `fullscreenchange` 同步按钮文案（`Fullscreen`/`退出全屏`）
  - 支持 ESC 退出全屏

### 4.3 配置中心 `src/views/Config.vue`

#### 主要功能

- **[视频源选择 & 背景帧]**
  - 选择一个视频源（目前基于视频列表）
  - 从 IndexedDB 取视频文件，截取一帧作为背景图（`getVideoFrame`）
- **[区域管理]**
  - 拉取 `/api/zones?sourceId=<当前视频ID>` 展示已有区域
  - 下拉选择区域，右侧属性面板编辑区域属性：
    - 区域名称 `name`
    - 区域类型 `type`（core/warning）
    - 触发阈值 `threshold`
    - 移动侦测开关 `motion`
- **[绘制多边形]**
  - 点击“绘制多边形”进入绘制模式
  - 画布点击添加点，拖拽调整点位
  - 末点靠近起点自动闭合 / 双击完成
  - `Ctrl+Z` 撤销一步（绘制或编辑）
  - `ESC/右键` 取消绘制
- **[编辑多边形]**
  - 选中区域后，拖拽顶点实时修改 polygonPoints
  - `Ctrl+Z` 撤销编辑
  - 点击“应用更改”调用 `/api/zones/:id` 更新
- **[删除区域]**
  - 删除选中区域 `/api/zones/:id`
- **[保存配置]**
  - 调用 `/api/config/save`（当前为演示接口）

> 与仪表盘的“区域同步”通过同一份 `/api/zones` 数据实现（按 sourceId/videoId 维度）。

### 4.4 报警记录 `src/views/History.vue`

- **[列表查询]**
  - 支持按关键字、等级、日期范围筛选
  - 调用 `/api/alarms?page&pageSize&query&level&startDate&endDate`
- **[分页]**
  - Element Plus Pagination
- **[查看详情]**
  - 点击“查看详情”打开 dialog
  - 调用 `/api/alarms/:id` 获取详细信息（区域、备注等）

### 4.5 视频源管理 `src/views/Sources.vue`

#### 主要功能

- **[上传视频]**
  - 支持拖拽/选择上传（`el-upload`，auto-upload=false）
  - 前端读取真实文件元数据：
    - 文件名：`file.name`
    - 文件大小：`file.size`
    - 时长：通过 `<video preload="metadata">` 读取 duration
    - 上传时间：本地生成 `YYYY-MM-DD HH:mm`
  - 调用 `/api/videos/upload`（FormData + meta 字段）
  - 上传成功后：
    - 把文件写入 IndexedDB（`putVideoFile(row.id, file)`）
    - 刷新列表
- **[列表展示]**
  - 展示字段：文件名、ext、quality、size、duration、uploadAt、是否演示源
- **[预览]**
  - 优先使用本地 objectUrl（刚上传时立即可预览）
  - 否则使用 `previewUrl`
- **[设为演示源]**
  - `/api/videos/:id/set-demo`
- **[删除]**
  - 删除视频记录 `/api/videos/:id`
  - 同时删除 IndexedDB 本地文件 `deleteVideoFile(id)`

---

## 5. 数据与接口层（api + mock）

### 5.1 API 封装

- `src/api/http.js`
  - `baseURL: '/api'`
  - 统一处理 `{code, message, data}` 格式
- `src/api/videos.js`
  - `GET /videos`
  - `GET /videos/demo`
  - `POST /videos/upload`（FormData + 元数据）
  - `POST /videos/:id/set-demo`
  - `DELETE /videos/:id`
- `src/api/config.js`
  - `GET /sources`
  - `GET /zones?sourceId=...`
  - `POST /zones?sourceId=...`
  - `PUT /zones/:id`
  - `DELETE /zones/:id`
  - `POST /config/save?sourceId=...`
- `src/api/dashboard.js`
  - `GET /dashboard/events`
  - `GET /dashboard/overlays?sourceId=...`
  - `GET /zones?sourceId=...`（复用 zones）
- `src/api/history.js`
  - `GET /alarms`
  - `GET /alarms/:id`
- `src/api/system.js`
  - `GET /system/status`
  - `PUT /system/status`

### 5.2 Mock 数据模型（关键）

- `db.videos`：视频列表（id/name/ext/size/duration/uploadAt/isDemo/previewUrl）
- `db.sources`：仪表盘/配置中心“视频源列表”（目前映射自 videos）
- `db.system.currentSourceId`：仪表盘当前选择的 sourceId
- `db.zonesBySource[sourceId]`：每个视频源对应的区域列表
- `db.dashboard.overlaysBySource[sourceId]`：每个视频源的 bbox overlay
- `db.alarms`：报警历史列表与详情

---

## 6. 已实现的关键增强点（近期完善）

- **[区域同步]** 配置中心绘制区域可在仪表盘按同一视频源显示（共享 `/api/zones?sourceId=...`）
- **[视频源联动]** 上传新视频后：
  - mock 会同步更新 `db.sources`
  - 仪表盘会定时刷新 sources，下拉自动出现新视频
  - 同时初始化 `zonesBySource` 和 `overlaysBySource` 容器
- **[全屏]** 仪表盘实现真正全屏切换，并支持 ESC 退出
- **[上传真实元数据]** 视频源管理上传后展示真实文件名/大小/时长/上传时间

---

## 7. 注意事项 / 后续对接后端建议

- **[DEV 与 PROD 差异]** DEV 下依赖 MSW mock；上线需后端提供同等接口能力与数据结构
- **[视频文件存储]** 当前采用 IndexedDB 存本地文件用于播放/截帧；若要多端共享，需要后端存储并提供可访问的 URL
- **[sourceId 口径]** 当前 sourceId 采用 videoId（`vid-xx`）。后端应以同样口径存取 zones/overlays/system status
