# 智能周界安全平台（周界防护系统）管理系统原型演示报告

> 依据：
> - `前后端接口文档.md`
> - `前端功能文档.md`
> - 当前项目代码（`security-system-frontend/src`、`backend/app`）
>
> 说明：用户提到的 `软件需求规格说明书.docx` 在当前工作区目录中未找到，因此本报告无法引用该文档中的“需求编号/验收条款/非功能指标”等内容；如后续补充该文件路径或内容，可再次完善。

---

## 1. 演示目标与范围

### 1.1 演示目标

面向“周界防护管理系统”原型演示，展示：

- **登录与进入系统**（真实后端认证）
- **仪表盘态势展示**（Mock 数据：视频叠加、区域、实时事件）
- **视频源管理**（上传/预览/设为演示源/删除）
- **配置中心**（区域绘制/编辑/保存）
- **报警记录**（查询筛选/详情）

### 1.2 演示范围（混合模式）

- **真实后端**（FastAPI + SQLModel + PostgreSQL）：
  - 认证接口：`POST /api/token`（OAuth2 form，返回 JWT）
  - （可选）上传视频接口：`POST /api/videos/upload`（若演示强调真实上传）
- **前端 Mock（MSW）**：
  - Dashboard、Config、History、System、Zones、Alarms、Sources/Videos 等展示数据与流程
  - 目的：确保演示期间数据稳定、无需依赖复杂后端业务实现

---

## 2. 用户角色与权限模型（原型版）

### 2.1 用户角色

- **系统管理员（Admin）**
  - 登录进入系统
  - 查看仪表盘态势
  - 管理视频源（上传/预览/删除/设为演示源）
  - 配置区域（绘制/编辑/删除/保存）
  - 查看报警记录（筛选/详情）

### 2.2 登录态与鉴权机制（前端约定）

- token 存储：`localStorage.token`
- 请求头注入：Axios request interceptor 自动添加：
  - `Authorization: Bearer <token>`
- 路由守卫：非 public 路由（除 `/login`）必须存在 `localStorage.token`，否则跳转到 `/login?redirect=...`

---

## 3. 系统信息架构（页面与模块）

### 3.1 页面路由

- 登录：`/login`
- 仪表盘：`/`
- 配置中心：`/config`
- 报警记录：`/history`
- 视频源管理：`/sources`

### 3.2 全局布局（AppLayout）

- 顶栏：系统标题、时间日期、用户信息、退出入口
- 侧边栏：四个模块导航入口
- 页脚状态栏：系统在线状态、当前源、FPS、版本号等展示信息

---

## 4. 功能模块详述

## 4.1 登录模块（真实登录）

### 4.1.1 功能说明

- 用户输入账号/密码
- 调用后端认证接口获取 token
- 保存 token 到 `localStorage.token`
- 跳转至 redirect 或首页 `/`

### 4.1.2 操作流程

1. 进入登录页 `/login`
2. 输入用户名/密码
3. 点击“登录”
4. 成功：保存 token → 跳转首页
5. 失败：提示错误信息

### 4.1.3 接口与参数

- `POST /api/token`
- `Content-Type: application/x-www-form-urlencoded`
- 参数：
  - `username`
  - `password`
- 成功返回：

```json
{ "access_token": "...", "token_type": "bearer" }
```

---

## 4.2 仪表盘模块（Dashboard，Mock 数据展示）

### 4.2.1 功能说明

仪表盘用于展示系统实时态势，包括：

- 演示视频播放（演示源/当前视频源）
- 检测框叠加（Overlays bounding boxes）
- 区域多边形叠加（Zones polygons）
- 实时事件列表（Events）
- 视频源切换与系统状态同步
- 全屏展示

### 4.2.2 界面设计

- 主区域（左侧）：
  - 视频背景 + 视频播放
  - 右上角视频源选择下拉框
  - SVG 叠加层：区域 polygon
  - DIV 叠加层：检测框 bbox + label
  - 底部控制条：刷新演示源/刷新区域/全屏
- 右侧栏：
  - 实时事件列表（卡片式，按等级着色）
  - 查看全部告警入口

### 4.2.3 操作逻辑（演示脚本）

1. 进入仪表盘，自动初始化当前视频源
2. 播放演示视频：优先 IndexedDB 本地文件，否则使用 mock `previewUrl`
3. 显示检测框与区域叠加
4. 切换视频源：更新系统状态并刷新 overlays/zones
5. 刷新实时事件：手动刷新或定时轮询
6. 全屏显示：进入/退出全屏

### 4.2.4 Mock 接口（来自文档）

- `GET /api/system/status`
- `PUT /api/system/status`
- `GET /api/sources`
- `GET /api/videos/demo`
- `GET /api/dashboard/events?limit=20`
- `GET /api/dashboard/overlays?sourceId=...`
- `GET /api/zones?sourceId=...`

---

## 4.3 视频源管理模块（Sources：上传/预览/演示源）

### 4.3.1 功能说明

- 上传视频并记录元信息（文件名/大小/时长/上传时间等）
- 列表展示与搜索
- 预览播放
- 设为演示源（Dashboard 使用）
- 删除视频（同时删除 IndexedDB 缓存）

### 4.3.2 界面设计

- 上传区域：拖拽/点击上传（Element Plus `el-upload`）
- 视频列表：table 展示文件名/大小/时长/上传时间/操作
- 预览弹窗：video player

### 4.3.3 操作逻辑（演示脚本）

1. 上传视频（拖拽/选择文件）
2. 上传成功后写入 IndexedDB，列表刷新
3. 点击“预览”播放
4. 点击“设为演示源”，回到 Dashboard 展示演示源变化
5. 删除视频并同步清理本地缓存

### 4.3.4 接口（文档约定）

- `GET /api/videos?keyword=...`
- `POST /api/videos/upload`（multipart/form-data + meta 字段）
- `POST /api/videos/:id/set-demo`
- `GET /api/videos/demo`
- `DELETE /api/videos/:id`

---

## 4.4 配置中心模块（Config：区域绘制/编辑/保存）

### 4.4.1 功能说明

- 选择视频源作为配置对象
- 截取视频帧作为背景（IndexedDB 优先）
- 绘制/编辑/删除多边形区域
- 配置区域属性（名称/类型/阈值/移动侦测）
- 保存配置（演示接口）

### 4.4.2 界面设计

- 视频源选择
- 主画布：背景帧 + polygon 绘制层
- 属性面板：区域属性编辑
- 工具按钮：绘制、撤销、取消、应用更改、删除、保存配置

### 4.4.3 操作逻辑（演示脚本）

1. 选择视频源
2. 点击“绘制多边形”并在画布点击落点
3. 双击完成闭合，拖拽顶点调整
4. 修改区域属性并“应用更改”
5. 保存配置
6. 回 Dashboard 观察同 sourceId 的区域叠加同步

### 4.4.4 接口（Mock）

- `GET /api/zones?sourceId=...`
- `POST /api/zones?sourceId=...`
- `PUT /api/zones/:id`
- `DELETE /api/zones/:id`
- `POST /api/config/save?sourceId=...`

---

## 4.5 报警记录模块（History：查询/筛选/详情）

### 4.5.1 功能说明

- 告警列表展示与分页
- 支持筛选：关键字、等级、日期范围
- 查看告警详情（弹窗）

### 4.5.2 界面设计

- 筛选区：输入框/下拉/日期范围
- 列表：缩略图、ID、时间、目标、等级、状态
- 分页
- 详情弹窗：告警详情 + 时间线（timeline）

### 4.5.3 操作逻辑（演示脚本）

1. 进入报警记录页面
2. 选择等级/输入关键字筛选
3. 打开详情弹窗
4. 从 Dashboard 事件卡片跳转到 History（带 alarmId 联动）

### 4.5.4 接口（Mock）

- `GET /api/alarms?page&pageSize&query&level&startDate&endDate`
- `GET /api/alarms/:id`

---

## 5. 数据流与接口映射

### 5.1 前端 API 封装

- `src/api/http.js`
  - `baseURL: /api`
  - 统一处理 `{code,message,data}`
  - 自动注入 Authorization header

### 5.2 Mock 机制（DEV）

- `src/main.js`：DEV 启用 MSW worker
- `src/mocks/handlers.js`：定义 mock 接口
- `src/mocks/data/db.js`：内存数据库（videos/sources/zones/overlays/alarms/system 等）

### 5.3 本地视频缓存

- `src/storage/videoStore.js`：IndexedDB
- 上传成功后缓存本地文件，供 Dashboard 播放与 Config 截帧

---

## 6. 推荐演示顺序（8~12 分钟）

1. **登录**（30~60s）
2. **仪表盘态势**（2~3min）：视频/叠加/事件/切换/全屏
3. **配置中心**（2~3min）：绘制区域→保存→回 Dashboard 同步展示
4. **报警记录**（1~2min）：筛选→详情→Dashboard 联动跳转
5. **视频源管理**（2~3min）：上传→预览→设演示源→删除

---

## 7. 演示环境准备与应急方案

### 7.1 启动顺序

1. PostgreSQL 启动并可连接
2. 后端（8000）：
   - `python -m uvicorn app.main:app --app-dir backend --host 0.0.0.0 --port 8000 --reload`
3. 前端（Vite）：
   - `npm run dev`

### 7.2 账号

- admin / 123456

### 7.3 常见问题排查

- **未登录提示**：
  - 检查 `localStorage.token` 是否存在
  - 检查 Network 请求是否带 `Authorization: Bearer ...`
  - DEV 确认 `[MSW] Mocking enabled.`
- **接口 404**：
  - 确认 Vite proxy 已配置 `/api -> 8000`
  - 修改了 `vite.config.js` 后必须重启前端
- **仪表盘无数据**：
  - 检查 `/api/system/status`、`/api/dashboard/events` 是否被 MSW 返回

---

## 8. 功能模块清单（汇总）

- 登录与鉴权（真实 token）
- 仪表盘：视频播放、区域叠加、检测框、实时事件、切源、全屏
- 配置中心：区域绘制/编辑/保存
- 报警记录：筛选/分页/详情
- 视频源管理：上传/预览/设演示源/删除 + IndexedDB 缓存
